name: 'Conan library test, build, publish'

on:
  workflow_call:

env:
  AVOQA_GIT_TOKEN: ${{ secrets.AVOQA_GIT_TOKEN }}
  KUBA_AURORA_GIT_TOKEN: ${{ secrets.KUBA_AURORA_GIT_TOKEN }}
  KUBA_EMB_CI_GIT_TOKEN: ${{ secrets.KUBA_EMB_CI_GIT_TOKEN }}
  ARTIFACTORY_USERNAME: ${{ secrets.ARTIFACTORY_USERNAME }}
  ARTIFACTORY_TOKEN: ${{ secrets.ARTIFACTORY_TOKEN }}
  NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
  NEXUS_TOKEN: ${{ secrets.NEXUS_TOKEN }}
  SVN_USERNAME: ${{ secrets.SVN_USERNAME }}
  SVN_PASSWORD: ${{ secrets.SVN_PASSWORD }}
  FEATURE_BUILD_INFO_ENABLED: "false"
  CONAN_CONTEXT_PATH: ".conan-context/conan-context.yml"

jobs:
  generate-conan-context:
    runs-on: voqa-ubuntu-22-04
    container:
      image: docker-internal.it.voqa.com/aurora-compiler:main
      credentials:
        username: ${{ secrets.DOCKER_INTERNAL_REGISTRY_USERNAME}}
        password: ${{ secrets.DOCKER_INTERNAL_REGISTRY_TOKEN}}
    outputs:
      build-profile-list: ${{ steps.generate-build-profiles-list.outputs.list }}
      collectors-list: ${{ steps.generate-collectors-list.outputs.list }}
    steps:
      - uses: actions/checkout@v4
      - name: Generate the conan context
        run: |
          ## START GENERATE PYTHON SCRIPT
          cat > extract-conanfile-field.py <<EOF

          import importlib.util
          import inspect
          import sys

          def load_class(module_name):
            spec = importlib.util.find_spec(module_name)
            if spec is None:
              raise ImportError(f"Module '{module_name}' not found.")

            module = importlib.util.module_from_spec(spec)
            spec.loader.exec_module(module)

            classes = inspect.getmembers(module, inspect.isclass)
            for name, cls in inspect.getmembers(module, inspect.isclass):
              if cls.__module__ == module_name:
                return cls
            raise RuntimeError(f"No conan class found matching '{module_name}'")

          if __name__ == "__main__":
            field_to_extract = sys.argv[1]
            module_name = "conanfile"
            conan_class = load_class(module_name)
            conan_instance = conan_class()
            try:
              print(getattr(conan_instance, field_to_extract))
            except Exception as e:
              print("")
          EOF
          ## END GENERATE PYTHON SCRIPT

          echo "Search for bundle/user field in conanfile"
          bundle=$(python3 extract-conanfile-field.py bundle)
          if [ -z "$bundle" ] || [ "$bundle" = "None" ]; then
            echo "Unable to find bundle field in conanfile !"
            exit 1
          fi
          echo "Bundle found: $bundle"
          owner=$(echo $bundle | cut -d'/' -f1)
          echo "Owner: $owner"

          CONAN_CONTEXT_URL=https://api.github.com/repos/${bundle}/contents/conan-context.yml
          
          REF=""
          BRANCH_NAME="${GITHUB_REF_NAME}"
          if [ "$BRANCH_NAME" = "main" ]; then
            REF="main"
          elif [ -n "${GITHUB_BASE_REF}" ]; then
              REF="${GITHUB_BASE_REF}"
          else
            echo "Unable to set conan channel"
            exit 1
          fi

          mkdir -p .conan-context

          OWNER_GIT_TOKEN_SECRET="$(echo $owner | tr '[:lower:]' '[:upper:]' | tr '-' '_')_GIT_TOKEN"
          all_secrets='${{ tojson(secrets) }}'
          OWNER_GIT_TOKEN=$(echo $all_secrets | jq -r ".${OWNER_GIT_TOKEN_SECRET}")
          all_secrets=''
          
          if [ -z "${OWNER_GIT_TOKEN}" ] || [ "null" = "${OWNER_GIT_TOKEN}" ]; then
            echo "Secret ${OWNER_GIT_TOKEN_SECRET} not found !"
            echo "Please add secret ${OWNER_GIT_TOKEN_SECRET} to https://github.com/organizations/$owner/settings/secrets/actions"
          else
            echo "Found secret ${OWNER_GIT_TOKEN_SECRET} that will be use to download conan context at ${CONAN_CONTEXT_URL}"
          fi
          
          echo "Will download conan context at: ${CONAN_CONTEXT_URL}?ref=${REF}"
          curl --fail -H "Authorization: token ${OWNER_GIT_TOKEN}" \
                -H "Accept: application/vnd.github.v3.raw" \
                -L "${CONAN_CONTEXT_URL}?ref=${REF}" > "${CONAN_CONTEXT_PATH}"
      - name: 'Output the build profiles list'
        id: generate-build-profiles-list
        run: |
          FIELD="build.profiles"
          result=$(yq eval ".${FIELD} | type" "${CONAN_CONTEXT_PATH}")
          if [ "$result" = "!!seq" ]; then
            echo "list=$(yq -r ".${FIELD}" ${CONAN_CONTEXT_PATH} -o=json | jq -c)" >> "$GITHUB_OUTPUT"
          else
            echo "File: ${CONAN_CONTEXT_PATH} - Field '$FIELD' does not exist or is not an array."
            exit 1
          fi
      - name: 'Output the collectors list'
        id: generate-collectors-list
        run: |
          FIELD="build.collectors"
          result=$(yq eval ".${FIELD} | type" "${CONAN_CONTEXT_PATH}")
          if [ "$result" = "!!seq" ]; then
            echo "list=$(yq -r ".${FIELD}" ${CONAN_CONTEXT_PATH} -o=json | jq -c)" >> "$GITHUB_OUTPUT"
          else
            echo "File: ${CONAN_CONTEXT_PATH} - Field '$FIELD' does not exist or is not an array."
            exit 1
          fi
      - name: 'Upload conan context'
        uses: actions/upload-artifact@v4
        with:
          name: conan-context
          path: ${{ env.CONAN_CONTEXT_PATH }}
  unit-tests:
    runs-on: voqa-ubuntu-22-04
    container:
      image: docker-internal.it.voqa.com/aurora-compiler:main
      credentials:
        username: ${{ secrets.DOCKER_INTERNAL_REGISTRY_USERNAME}}
        password: ${{ secrets.DOCKER_INTERNAL_REGISTRY_TOKEN}}
    needs:
      - generate-conan-context
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: conan-context
          path: .conan-context
      - name: Configure Conan
        run: |
          git config --global url."https://github.com/".insteadOf git@github.com:
          
          organisations=$(yq -r '.organisations[]' ${CONAN_CONTEXT_PATH})
  
          if [ "null" = "$organisations" ]; then
            echo "Field organisations is missing in ${CONAN_CONTEXT_PATH}"
            echo "Please set it"
            exit 1
          fi
  
          if [ -z "$organisations" ]; then
            echo "Field organisations is empty in ${CONAN_CONTEXT_PATH}"
            echo "Skip conan git credentials configuration"
          else
            echo "Start conan git credentials configuration"
            all_secrets='${{ tojson(secrets) }}'
            for org in $organisations; do
              secret_to_extract=$(echo $org | tr '[:lower:]' '[:upper:]' | tr '-' '_')_GIT_TOKEN
              echo "Extracting github secret $secret_to_extract for organisation $org"
              secret=$(echo $all_secrets | jq -r ".$secret_to_extract")
              if [ "null" = "$secret" ]; then
                echo "Secret $secret_to_extract not found !"
                echo "Please add secret $secret_to_extract to https://github.com/organizations/$org/settings/secrets/actions"
                exit 1
              else
                echo "Secret $secret_to_extract found !"
                echo "Configure git conan credentials for https://github.com/$org"
                git config --global credential."https://github.com/$org".helper "!f() { sleep 1; echo \"username=github\"; echo \"password=${secret}\"; }; f"
              fi
            done
          fi
          
          echo "Start conan install config"
          conan_config_url=$(yq e '.conan.config.url' ${CONAN_CONTEXT_PATH})
          conan_config_branch=$(yq e '.conan.config.branch' ${CONAN_CONTEXT_PATH})
          if [ -z "$conan_config_url" ] || [ "null" = "$conan_config_url" ]; then
            echo "Field conan.config.url is missing in ${CONAN_CONTEXT_PATH}"
            echo "Please add it"
            exit 1
          fi
          if [ -z "$conan_config_branch" ] || [ "null" = "$conan_config_branch" ]; then
            echo "Field conan.config.branch is missing in ${CONAN_CONTEXT_PATH}, use main by default"
            conan_config_branch="main"
          fi
          echo "Will use conan_config_url: ${conan_config_url}, conan_config_branch: ${conan_config_branch}"
  
          conan config install "${conan_config_url}" --args="-b ${conan_config_branch}"
  
          conan remote login -p "$ARTIFACTORY_TOKEN" "VOQA-SNAPSHOTS" "$ARTIFACTORY_USERNAME"
          conan remote login -p "$ARTIFACTORY_TOKEN" "VOQA-RELEASES"  "$ARTIFACTORY_USERNAME"
      - run: bash test.sh
      - name: Extract test report
        run: |
          mkdir -p ci-report
          find ~/.conan2 -name junit-results.xml -exec cp {} ci-report/ \; || echo "Not able to find test results"
      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v4
        if: success() || failure()
        with:
          report_paths: 'ci-report/junit-results.xml'
  quality-analysis:
    runs-on: ubuntu-latest
    needs:
      - generate-conan-context
    steps:
      - run: echo "Will run a SonarQube analysis"
  build-and-upload:
    runs-on: voqa-ubuntu-22-04
    needs:
      - generate-conan-context
      - unit-tests
      - quality-analysis
    strategy:
      matrix:
        profile: ${{ fromJson(needs.generate-conan-context.outputs.build-profile-list) }}
    container:
      image: docker-internal.it.voqa.com/${{ matrix.profile }}-compiler:main
      credentials:
        username: ${{ secrets.DOCKER_INTERNAL_REGISTRY_USERNAME}}
        password: ${{ secrets.DOCKER_INTERNAL_REGISTRY_TOKEN}}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: conan-context
          path: .conan-context
      - name: Configure Conan
        run: |
          git config --global url."https://github.com/".insteadOf git@github.com:
          git config --global credential."https://github.com/aVOQA".helper "!f() { sleep 1; echo \"username=github\"; echo \"password=${AVOQA_GIT_TOKEN}\"; }; f"
          git config --global credential."https://github.com/KUBA-Aurora".helper "!f() { sleep 1; echo \"username=github\"; echo \"password=${KUBA_AURORA_GIT_TOKEN}\"; }; f"
          git config --global credential."https://github.com/KUBA-EMB-CI".helper "!f() { sleep 1; echo \"username=github\"; echo \"password=${KUBA_EMB_CI_GIT_TOKEN}\"; }; f"
          conan config install https://github.com/KUBA-EMB-CI/conan-config.git
          sed -i 's/http:\/\//https:\/\//' ~/.conan2/remotes.json
          conan remote login -p "$ARTIFACTORY_TOKEN" "VOQA-SNAPSHOTS" "$ARTIFACTORY_USERNAME"
          conan remote login -p "$ARTIFACTORY_TOKEN" "VOQA-RELEASES" "$ARTIFACTORY_USERNAME"
          if [ "$FEATURE_BUILD_INFO_ENABLED" == "true" ]; then
            conan config install https://github.com/conan-io/conan-extensions.git
            conan art:server add artifactoryServer https://artifactory.it.voqa.com/artifactory --user "$ARTIFACTORY_USERNAME" --token "$ARTIFACTORY_TOKEN" || true
          fi
      - name: Conan create
        run: |
          conan create . --format json -pr:h ${{ matrix.profile }} --build=missing >  create_${{ matrix.profile }}.json
          if [ "$FEATURE_BUILD_INFO_ENABLED" == "true" ]; then
            conan art:build-info create create_${{ matrix.profile }}.json ${{ matrix.profile }} 1 VOQA_RELEASES --server artifactoryServer --with-dependencies  --user "$ARTIFACTORY_USERNAME" --token "$ARTIFACTORY_TOKEN"  > ${{ matrix.profile }}.json
          fi
      - name: Conan upload
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
        run: |
          BRANCH_NAME="${GITHUB_REF_NAME}"
          if [ "$BRANCH_NAME" = "main" ]; then
            conan upload '*' -r VOQA-SNAPSHOTS --confirm
          elif [ -n "$GITHUB_BASE_REF" ]; then
            conan upload '*' -r VOQA-RELEASES --confirm
          else
            echo "Unable to set conan channel"
            exit 1
          fi
          if [ "$FEATURE_BUILD_INFO_ENABLED" == "true" ]; then
            conan art:build-info upload ${{ matrix.profile }}.json --server artifactoryServer  --user "$ARTIFACTORY_USERNAME" --token "$ARTIFACTORY_TOKEN" 
          fi
  rebuild-collectors:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    needs:
      - generate-conan-context
      - build-and-upload
    strategy:
      matrix:
        collector: ${{ fromJson(needs.generate-conan-context.outputs.collectors-list) }}
    steps:
      - name: dispatch workflow of ${{ matrix.collector }}
        run: |
          # shellcheck disable=SC2086
          curl -v -L -X POST -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${KUBA_AURORA_GIT_TOKEN}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                https://api.github.com/repos/KUBA-Aurora/${{ matrix.collector }}/actions/workflows/main.yml/dispatches \
                -d '{"ref":"'$GITHUB_REF_NAME'","inputs":{"rebuild_cause":"Change in '$GITHUB_REF_NAME' of ${{ github.repository }}","linked_commit":"https://github.com/${{ github.repository }}/commit/${{ github.sha }}"}}'
