name: 'Conan library test, build, publish'

on:
  workflow_call:
    inputs:
      enable-quality-analysis:
        description: 'Enable or not the SonarQube analysis'
        required: false
        type: boolean
        default: true
      enable-rebuild-collectors:
        description: 'Enable or not the rebuild of collectors'
        required: false
        type: boolean
        default: true

env:
  SVN_USERNAME: ${{ secrets.SVN_USERNAME }}
  SVN_PASSWORD: ${{ secrets.SVN_PASSWORD }}
  CONAN_CONTEXT_PATH: ".conan-context/conan-context.yml"

jobs:
  generate-conan-context:
    runs-on: voqa-ubuntu-22-04
    container:
      image: docker-internal.it.voqa.com/aurora-compiler:main
      credentials:
        username: ${{ secrets.DOCKER_INTERNAL_REGISTRY_USERNAME}}
        password: ${{ secrets.DOCKER_INTERNAL_REGISTRY_TOKEN}}
    outputs:
      build-profile-list: ${{ steps.generate-conan-context.outputs.build-profile-list }}
      collectors-list: ${{ steps.generate-conan-context.outputs.collectors-list }}
    steps:
      - uses: actions/checkout@v4
      - uses: KUBA-EMB-CI/action-generate-conan-context@main
        id: generate-conan-context
        with:
          json-secrets: ${{ toJson(secrets) }}
  unit-tests:
    runs-on: voqa-ubuntu-22-04
    container:
      image: docker-internal.it.voqa.com/aurora-compiler:main
      credentials:
        username: ${{ secrets.DOCKER_INTERNAL_REGISTRY_USERNAME}}
        password: ${{ secrets.DOCKER_INTERNAL_REGISTRY_TOKEN}}
    needs:
      - generate-conan-context
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: conan-context
          path: .conan-context
      - name: Configure Conan
        uses: KUBA-EMB-CI/action-configure-conan@main
        with:
          json-secrets: ${{ toJson(secrets) }}
          conan-context-path: ${{ env.CONAN_CONTEXT_PATH }}

      - run: bash test.sh
      - name: Extract test report
        run: |
          mkdir -p ci-report
          find ~/.conan2 -name junit-results.xml -exec cp {} ci-report/ \; || echo "Not able to find test results"
      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v4
        if: success() || failure()
        with:
          report_paths: 'ci-report/junit-results.xml'
  quality-analysis:
    runs-on: ubuntu-latest
    needs:
      - generate-conan-context
    if: inputs.enable-quality-analysis
    steps:
      - run: echo "Will run a SonarQube analysis"
  build-and-upload:
    runs-on: voqa-ubuntu-22-04
    needs:
      - generate-conan-context
      - unit-tests
    strategy:
      matrix:
        profile: ${{ fromJson(needs.generate-conan-context.outputs.build-profile-list) }}
    container:
      image: docker-internal.it.voqa.com/${{ matrix.profile }}-compiler:main
      credentials:
        username: ${{ secrets.DOCKER_INTERNAL_REGISTRY_USERNAME}}
        password: ${{ secrets.DOCKER_INTERNAL_REGISTRY_TOKEN}}
    steps:
      - uses: actions/checkout@v4
      - name: Set safe git path
        run: |
          repo=$(basename ${{ github.repository }})
          git config --global --add safe.directory "/__w/${repo}/${repo}"
      - uses: actions/download-artifact@v4
        with:
          name: conan-context
          path: .conan-context
      - name: Configure Conan
        uses: KUBA-EMB-CI/action-configure-conan@main
        with:
          json-secrets: ${{ toJson(secrets) }}
          conan-context-path: ${{ env.CONAN_CONTEXT_PATH }}
      - name: Conan create
        run: |
          conan create . --format json -pr:h ${{ matrix.profile }} --build=missing >  create_${{ matrix.profile }}.json
      - name: Conan upload
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/') || startsWith(github.ref, 'refs/heads/release/')
        run: |
          upload=$(yq e '.upload' "${CONAN_CONTEXT_PATH}")
          if [ -z "${upload}" ] || [ "null" = "${upload}" ]; then
            echo "Field upload is missing in ${CONAN_CONTEXT_PATH}"
            echo "Please add it"
            exit 1
          else
            echo "Conan upload to repository ${upload}"
          fi
          conan upload '*' -r "${upload}" --confirm
  rebuild-collectors:
    runs-on: ubuntu-latest
    if: inputs.enable-rebuild-collectors && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    needs:
      - generate-conan-context
      - build-and-upload
    strategy:
      matrix:
        collector: ${{ fromJson(needs.generate-conan-context.outputs.collectors-list) }}
    steps:
      - name: dispatch workflow of ${{ matrix.collector }}
        run: |
          owner=$(echo "${{ matrix.collector }}" | cut -d'/' -f1)
          echo "Owner of collector: $owner"
          OWNER_GIT_TOKEN_SECRET=GIT_TOKEN_$(echo "$owner" | tr '[:lower:]' '[:upper:]' | tr '-' '_')
          # shellcheck disable=SC2086
          all_secrets='${{ tojson(secrets) }}'
          OWNER_GIT_TOKEN=$(echo "$all_secrets" | jq -r ".${OWNER_GIT_TOKEN_SECRET}")
          all_secrets=''
          if [ -z "${OWNER_GIT_TOKEN}" ] || [ "null" = "${OWNER_GIT_TOKEN}" ]; then
            echo "Secret ${OWNER_GIT_TOKEN_SECRET} not found !"
            echo "Please add secret ${OWNER_GIT_TOKEN_SECRET} to https://github.com/organizations/${GITHUB_REPOSITORY_OWNER}/settings/secrets/actions"
          else
            echo "Found secret ${OWNER_GIT_TOKEN_SECRET} that will be use to trigger rebuild of ${{ matrix.collector }}"
          fi
          # shellcheck disable=SC2086
          curl --fail -L -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${OWNER_GIT_TOKEN}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "https://api.github.com/repos/${{ matrix.collector }}/actions/workflows/main.yml/dispatches" \
                -d '{"ref":"'$GITHUB_REF_NAME'","inputs":{"rebuild_cause":"Change in '$GITHUB_REF_NAME' of ${{ github.repository }}","linked_commit":"https://github.com/${{ github.repository }}/commit/${{ github.sha }}"}}'
